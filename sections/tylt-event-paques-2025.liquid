{% schema %}
{
  "name": "TYLT - PAQUES 2025",
  "blocks": [
    {
      "type": "icon",
      "name": "Icon + Texte",
      "settings": [
        {
          "type": "image_picker",
          "id": "oeuf",
          "label": "Image Oeuf"
        },
        {
          "type": "richtext",
          "id": "text_popup",
          "label": "Texte Pop-up"
        },
        {
          "type": "text",
          "id": "code_promo",
          "label": "Code Promo"
        },
        {
          "type": "number",
          "id": "apparation_time",
          "label": "Apparait toute les Xsecondes",
          "default": 1000
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "TYLT - PAQUES 2025"
    }
  ]
}
{% endschema %}

<div id="tylt-easter-eggs-container" class="easter-eggs-hidden">
  {% for block in section.blocks %}
    <span
      class="tylt_event_bloc__image fade-out"
      style="background-image:url('{{ block.settings.oeuf | image_url }}')"
      data-apparation="{{ block.settings.apparation_time | default: 1000 }}"
      data-popup="{{ block.settings.text_popup | escape }}"
      data-code="{{ block.settings.code_promo }}"
    ></span>
    {% comment %} POP UP {% endcomment %}
    <div id="easter-popup" class="easter-popup hidden">
      <div class="easter-popup-inner">
        <button class="easter-popup-close">×</button>
        <div id="easter-popup-text"></div>
        <div id="easter-popup-code"></div>
      </div>
    </div>
  {% endfor %}
</div>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const container = document.getElementById("tylt-easter-eggs-container");

    // Date actuelle
    const now = new Date();
    const currentYear = now.getFullYear();

    // Date de début : 19 avril 2025 à 23h59
    const startDate = new Date(`${currentYear}-04-19T23:59:00`);
    // Date de fin : 22 avril 2025 à 00h01
    const endDate = new Date(`${currentYear}-04-22T00:01:00`);

    if (now >= startDate && now <= endDate) {
      container.classList.remove("easter-eggs-hidden");
    } else {
      container.remove(); // ou container.classList.add("easter-eggs-hidden");
    }
  });

  document.addEventListener('DOMContentLoaded', () => {
    const eggs = document.querySelectorAll('.tylt_event_bloc__image');
    const popup = document.getElementById('easter-popup');
    const popupText = document.getElementById('easter-popup-text');
    const popupCode = document.getElementById('easter-popup-code');
    const closeBtn = document.querySelector('.easter-popup-close');

    eggs.forEach((egg) => {
      egg.addEventListener('click', () => {
        const popupHTML = egg.dataset.popup;
        const code = egg.dataset.code;
  
        popupText.innerHTML = popupHTML;
        if (code) {
          popupCode.innerHTML = `<strong>Code promo :</strong> <span class="copy-code" style="cursor: pointer; color:rgb(255, 157, 0);" title="Clique pour copier">${code}</span>`;
        }
        popup.classList.remove('hidden');
      });
    });
  
    closeBtn.addEventListener('click', () => {
      popup.classList.add('hidden');
    });

    popupCode.addEventListener('click', (e) => {
      if (e.target.classList.contains('copy-code')) {
        const code = e.target.textContent;
    
        navigator.clipboard.writeText(code).then(() => {
          const originalText = e.target.textContent;
          e.target.textContent = 'Copié !';
          setTimeout(() => {
            e.target.textContent = originalText;
          }, 1000);
        });
      }
    });
  });
  

  //Aparitions des oeufs
  document.addEventListener('DOMContentLoaded', () => {
    const eggs = document.querySelectorAll('.tylt_event_bloc__image');

    function animateEgg(egg) {
      const pageWidth = document.body.scrollWidth;
      const eggWidth = egg.offsetWidth || 60;
      const eggHeight = egg.offsetHeight || 60;

      const containerRect = document.getElementById('tylt-easter-eggs-container').getBoundingClientRect();
      const containerTop = containerRect.top + window.scrollY;

      // Choisir aléatoirement gauche (0–10vw) ou droite (90–100vw)
      const isLeftSide = Math.random() < 0.5;
      let x;

      if (isLeftSide) {
        const minX = 0;
        const maxX = window.innerWidth * 0.05 - eggWidth;
        x = Math.random() * (maxX - minX) + minX;
      } else {
        const minX = window.innerWidth * 0.95;
        const maxX = window.innerWidth - eggWidth;
        x = Math.random() * (maxX - minX) + minX;
      }

      // Permet aux œufs d’apparaître entre le haut de la page (en négatif) et le bas visible
      const minY = -containerTop;
      const maxY = document.body.scrollHeight - eggHeight - containerTop;
      console.log(maxY);
      const y = Math.random() * (maxY - minY) + minY;

      egg.style.left = `${x}px`;
      egg.style.top = `${y}px`;

      const visibleDuration = Math.random() * 3000 + 5000;

      // Apparition
      setTimeout(() => {
        egg.classList.remove('fade-out');
        
        // Disparition après durée visible
        setTimeout(() => {
          egg.classList.add('fade-out');

          // Délai avant réapparition selon setting
          const apparationTime = parseInt(egg.dataset.apparation) || 1000;

          setTimeout(() => {
            animateEgg(egg);
          }, apparationTime);
        }, visibleDuration);
      }, 100);
    }

    eggs.forEach((egg) => {
      const apparationTime = parseInt(egg.dataset.apparation) || 1000;
    
      setTimeout(() => {
        animateEgg(egg);
      }, apparationTime);
    });
  });
</script>

<style>
  .easter-popup {
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    width: 100vw;
  }
  .easter-popup.hidden {
    display: none;
  }
  .easter-popup-inner {
    background: #fff;
    padding: 2rem;
    border-radius: 12px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  .easter-popup-close {
    position: absolute;
    top: 10px;
    right: 15px;
    background: transparent;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
  }

  #tylt-easter-eggs-container {
    position: relative;
    width: 100%;
    height: 100%;
    overflow-x: clip;
  }
  .tylt_event_bloc__image {
    position: absolute;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    display: block;
    width: 60px;
    height: 60px;
    transition: opacity 0.2s ease-out, scale 0.2s ease-out;
    opacity: 1;
    scale: 1;
    z-index: 1000;
    animation: rotate 5s infinite cubic-bezier(0.175, 0.885, 0.32, 1.275) alternate;
    cursor: pointer;
  }

  .fade-out {
    opacity: 0;
    pointer-events: none;
    scale: 0;
  }
  @keyframes rotate {
    0% {
      rotate: -15deg;
    }
    100% {
      rotate: 15deg;
    }
  }
</style>
